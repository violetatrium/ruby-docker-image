---
version: 2.1
orbs:
  docker: circleci/docker@0.5.1
  clair-scanner: ovotech/clair-scanner@1.4.33

jobs:
  build:
    executor: docker/machine
    steps:
      - checkout
      - docker/check
      - run: |
          make image
          echo $(docker image inspect --format="{{index .RepoDigests 0}}" minimsecure/ruby-docker-image) > /tmp/image.txt
      - store_artifacts:
          path: /tmp/image.txt
          destination: image

  scan:
    executor: clair-scanner/default
    steps:
      - checkout
      - clair/scan:
          image_file:
            /tmp/image.txt

workflows:
  build_test_deploy:
    jobs:
      - build
      - scan:
          requires:
            - build
